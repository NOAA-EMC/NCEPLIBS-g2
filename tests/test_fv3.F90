! This is a test program for NCEPLIBS-g2.
!
! This program tests reading a very large FV3 GRIB2 file, only
! downloaded if both the FTP_TEST_FILES and the FTP_LARGE_TEST_FILES
! are set to ON at build time.
!
! Ed Hartnett 7/17/23
program test_fv3
  use grib_mod
  implicit none
  
  ! THese are the test files we will use.
  character(*) :: TEST_FILE
  parameter (TEST_FILE = 'data/fv3lam.t00z.prslev.f000.grib2')
  integer :: NUM_MSG
  parameter (NUM_MSG = 555)
  integer :: lugb = 10
  integer :: jdisc = -1, jpdtn = -1, jgdtn = -1, jskp = 0
  integer, dimension(200) :: jids, jpdt, jgdt
  logical :: unpack = .true.
  type(gribfield) :: gfld
  integer :: i
  integer*8 :: lskip8, lgrib8, start8
  integer :: iret
  integer*8 :: expected_lskip8(NUM_MSG) = (/0, 13342681, 24228864, 26958473, 28943885, 33491509, &
       35662921, 37513651, 41466849, 49796382, &
       52338669, 54145441, 59420674, 70005385, 80346316, 94134044, &
       109418487, 124174637, 135296376, 146267769, &
       160530839, 163669983, 165476755, 176358032, 178967180, 180956974, &
       185509096, 187687857, 189539360, 193442018, &
       201755899, 204248168, 206054940, 211395997, 221765391, 231845074, &
       247029419, 258193997, 269162211, 270968983, &
       281705758, 282502959, 284309731, 286116503, 291699618, 300208170, &
       304072773, 304072964, 323776602, 332190201, &
       340619636, 347064318, 355139879, 356946651, 360886552, 370720872, &
       375977362, 378424610, 380231410, 388331078, &
       400797779, 406269857, 412685033, 418813138, 420619910, 422426710, &
       424233510, 426040310, 427847110, 429653910, &
       431460682, 441754179, 447002535, 451243787, 453050587, 461065023, &
       475743186, 481235700, 488100961, 494533623, &
       496340395, 498147195, 499953995, 501760795, 503567595, 505374395, &
       507181167, 517646580, 522845984, 525489292, &
       527296092, 535328763, 545493401, 551105100, 558067631, 564682673, &
       566489445, 568296245, 570103045, 571909845, &
       573716645, 575523445, 577330217, 587207321, 592583068, 596359990, &
       598166790, 606406969, 617728930, 623453884, &
       630811823, 637722772, 639529544, 641336344, 643143144, 644949944, &
       646756744, 648563544, 650370316, 660243874, &
       665782341, 668893391, 670700191, 678999403, 692158895, 697902691, &
       706018267, 713697696, 715504468, 717311268, &
       719118068, 720924868, 722731668, 724538468, 726345240, 736003584, &
       741491761, 745446508, 747253308, 754605322, &
       768690322, 774342531, 782404130, 790158517, 791965289, 793772089, &
       795578889, 797385689, 799192526, 800999326, &
       802806098, 813778601, 819270213, 821200805, 823007870, 828611751, &
       842007876, 847558692, 855818678, 863713621, &
       865520393, 867327193, 869199887, 871006687, 872885216, 874759560, &
       876566332, 887827025, 893234524, 895429188, &
       897242426, 903101132, 913175074, 918574960, 926605176, 934364056, &
       936170828, 937977628, 939816319, 941623119, &
       943455166, 945262345, 947069117, 956539236, 962177555, 965440305, &
       967315637, 973843552, 985559340, 991280475, &
       1000260351, 1009017827, 1010824599, 1012631399, 1014596572, 1016403372, &
       1018363592, 1020173441, 1021980213, 1031670555, &
       1037269263, 1040837093, 1043996969, 1051437343, 1062293962, 1068054150, &
       1077080825, 1085824114, 1087630886, 1089437686, &
       1091632072, 1093438872, 1095608817, 1097425447, 1099232219, 1109165718, &
       1114775704, 1118828103, 1127590579, 1136236814, &
       1144401667, 1150240654, 1159272325, 1168036210, 1169842982, 1171649782, &
       1174120612, 1175927412, 1178327480, 1180142059, &
       1181948831, 1191453928, 1197002262, 1201495517, 1211216292, 1217955715, &
       1226630809, 1232592261, 1241781787, 1247721790, &
       1249528562, 1251335362, 1254250483, 1256057394, 1258730705, 1260548537, &
       1262355309, 1271911139, 1277527887, 1282467250, &
       1296500907, 1304389633, 1313594204, 1319711223, 1329269981, 1335399673, &
       1337209617, 1339016389, 1340823189, 1344298910, &
       1346106764, 1349244152, 1351064417, 1352871189, 1362453927, 1368092865, &
       1373495944, 1389049914, 1398211666, 1407854034, &
       1414094480, 1423895659, 1430136369, 1431943141, 1433750598, 1437435460, &
       1439245621, 1442903894, 1444727127, 1446533899, &
       1456117316, 1461736427, 1467592438, 1484192419, 1490888200, 1500992441, &
       1507329866, 1517344757, 1523654157, 1525880720, &
       1529365718, 1531172490, 1532983700, 1536913815, 1538739158, 1542849663, &
       1544675501, 1546482273, 1556067456, 1561651504, &
       1567575002, 1584595114, 1591881604, 1602297666, 1608702225, 1618642970, &
       1624983602, 1626790374, 1628608164, 1633070737, &
       1634920612, 1639380363, 1641208721, 1643015493, 1652586730, 1658125850, &
       1664074201, 1681193007, 1688945453, 1699565835, &
       1705991351, 1715885564, 1722223834, 1724552435, 1726359207, 1728184164, &
       1732602687, 1734468695, 1739169811, 1741000601, &
       1742807373, 1752379144, 1757871168, 1763826728, 1780837257, 1789041009, &
       1799774719, 1806193077, 1815989272, 1822288783, &
       1824095555, 1825928155, 1830210031, 1832077708, 1836918030, 1838751400, &
       1840558172, 1850167467, 1855569067, 1861451105, &
       1876595690, 1885110695, 1895927171, 1902325015, 1912013838, 1918272047, &
       1920078819, 1921923261, 1925957631, 1927845861, &
       1932710181, 1934546228, 1936353000, 1945969565, 1951454983, 1957285982, &
       1972280033, 1981096580, 1991992920, 1998371058, &
       2008018333, 2014254181, 2016060953, 2017927542, 2022006835, 2023917386, &
       2028717243, 2030555879, 2032362651, 2041946305, &
       2047490029, 2053319040, 2068293784, 2077559731, 2088558356, 2094924735, &
       2104635615, 2114215568, 2116028414, 2117835186, &
       2119743433, 2123583500, 2125509518, 2130199220, 2132041460, 2133848232, &
       2143838088, 2149439845, 2155300928, 2170383489, &
       2180053911, 2191129897, 2197484390, 2207284167, 2216916377, 2218723149, &
       2220670766, 2224486664, 2226418221, 2230977116, &
       2232822567, 2234629339, 2244656492, 2250253051, 2256080669, 2270997863, &
       2280853785, 2291901199, 2298188353, 2307840648, &
       2317306653, 2319113425, 2321129753, 2325008550, 2326964756, 2331428147, &
       2333276729, 2335083501, 2345172551, 2350703006, &
       2356501740, 2371322518, 2381383238, 2392418937, 2398658027, 2408227384, &
       2417595237, 2419402009, 2421517733, 2425150718, &
       2427117204, 2431475559, 2433327804, 2435134576, 2445215668, 2450865483, &
       2456688311, 2471670771, 2482148645, 2493240939, &
       2499465549, 2509096995, 2518416762, 2520228855, 2525587219, 2527393991, &
       2529648573, 2533078876, 2535061604, 2539659278, &
       2541515383, 2543322155, 2553397007, 2559120033, 2565023486, 2580080084, &
       2591000119, 2602184923, 2608414611, 2618188998, &
       2627641301, 2629448073, 2631830292, 2635279573, 2637312837, 2641771909, &
       2643632165, 2645438937, 2655456301, 2661127864, &
       2667060572, 2682018954, 2693166548, 2704363178, 2710559245, 2720300014, &
       2729728251, 2731535023, 2734073716, 2737461479, &
       2739512697, 2743916415, 2745781442, 2747588214, 2757757035, 2763512727, &
       2769471516, 2784305815, 2795664291, 2806889029, &
       2813059587, 2822774306, 2832169446, 2833976218, 2836721084, 2839963634, &
       2842146002, 2846480890, 2848350670, 2850157470, &
       2860229934, 2866026061, 2872040708, 2886839289, 2898468354, 2909783979, &
       2915952326, 2925750651, 2935224520, 2937031292, &
       2939947664, 2943198694, 2945532711, 2949762408, 2951635025, 2953441825, &
       2963507573, 2969356923, 2975427653, 2990285995, &
       2998055593, 3009494974, 3015626446, 3025579499, 3035210640, 3037017412, 3040052556, &
       3043101196, 3045573697, 3049660226, 3051531677, &
       3053338477, 3063415986, 3069235019, 3075343154, 3090198941, 3098139265, &
       3109680464, 3115822302, 3125841746, 3135552951, &
       3137359723, 3140485044, 3143402665, 3145986981 /)
  integer*8 :: expected_lgrib8(NUM_MSG) = (/ 13342681, 10886183, 2729609, 1985412, 4547624, &
       2171412, 1850730, 3953198, 8329533, 2542287, &
       1806772, 5275233, 10584711, 10340931, 13787728, &
       15284443, 14756150, 11121739, 10971393, 14263070, &
       3139144, 1806772, 10881277, 2609148, 1989794, &
       4552122, 2178761, 1851503, 3902658, 8313881, &
       2492269, 1806772, 5341057, 10369394, 10079683, &
       15184345, 11164578, 10968214, 1806772, 10736775, &
       797201, 1806772, 1806772, 5583115, 8508552, &
       3864603, 191, 19703638, 8413599, 8429435, &
       6444682, 8075561, 1806772, 3939901, 9834320, &
       5256490, 2447248, 1806800, 8099668, 12466701, &
       5472078, 6415176, 6128105, 1806772, 1806800, &
       1806800, 1806800, 1806800, 1806800, 1806772, &
       10293497, 5248356, 4241252, 1806800, 8014436, &
       14678163, 5492514, 6865261, 6432662, 1806772, &
       1806800, 1806800, 1806800, 1806800, 1806800, &
       1806772, 10465413, 5199404, 2643308, 1806800, &
       8032671, 10164638, 5611699, 6962531, 6615042, &
       1806772, 1806800, 1806800, 1806800, 1806800, &
       1806800, 1806772, 9877104, 5375747, 3776922, &
       1806800, 8240179, 11321961, 5724954, 7357939, &
       6910949, 1806772, 1806800, 1806800, 1806800, &
       1806800, 1806800, 1806772, 9873558, 5538467, &
       3111050, 1806800, 8299212, 13159492, 5743796, &
       8115576, 7679429, 1806772, 1806800, 1806800, &
       1806800, 1806800, 1806800, 1806772, 9658344, &
       5488177, 3954747, 1806800, 7352014, 14085000, &
       5652209, 8061599, 7754387, 1806772, 1806800, &
       1806800, 1806800, 1806837, 1806800, 1806772, &
       10972503, 5491612, 1930592, 1807065, 5603881, &
       13396125, 5550816, 8259986, 7894943, 1806772, &
       1806800, 1872694, 1806800, 1878529, 1874344, &
       1806772, 11260693, 5407499, 2194664, 1813238, &
       5858706, 10073942, 5399886, 8030216, 7758880, &
       1806772, 1806800, 1838691, 1806800, 1832047, &
       1807179, 1806772, 9470119, 5638319, 3262750, &
       1875332, 6527915, 11715788, 5721135, 8979876, &
       8757476, 1806772, 1806800, 1965173, 1806800, &
       1960220, 1809849, 1806772, 9690342, 5598708, &
       3567830, 3159876, 7440374, 10856619, 5760188, &
       9026675, 8743289, 1806772, 1806800, 2194386, &
       1806800, 2169945, 1816630, 1806772, 9933499, &
       5609986, 4052399, 8762476, 8646235, 8164853, &
       5838987, 9031671, 8763885, 1806772, 1806800, &
       2470830, 1806800, 2400068, 1814579, 1806772, &
       9505097, 5548334, 4493255, 9720775, 6739423, &
       8675094, 5961452, 9189526, 5940003, 1806772, &
       1806800, 2915121, 1806911, 2673311, 1817832, &
       1806772, 9555830, 5616748, 4939363, 14033657, &
       7888726, 9204571, 6117019, 9558758, 6129692, &
       1809944, 1806772, 1806800, 3475721, 1807854, &
       3137388, 1820265, 1806772, 9582738, 5638938, &
       5403079, 15553970, 9161752, 9642368, 6240446, &
       9801179, 6240710, 1806772, 1807457, 3684862, &
       1810161, 3658273, 1823233, 1806772, 9583417, &
       5619111, 5856011, 16599981, 6695781, 10104241, &
       6337425, 10014891, 6309400, 2226563, 3484998, &
       1806772, 1811210, 3930115, 1825343, 4110505, &
       1825838, 1806772, 9585183, 5584048, 5923498, &
       17020112, 7286490, 10416062, 6404559, 9940745, &
       6340632, 1806772, 1817790, 4462573, 1849875, &
       4459751, 1828358, 1806772, 9571237, 5539120, &
       5948351, 17118806, 7752446, 10620382, 6425516, &
       9894213, 6338270, 2328601, 1806772, 1824957, &
       4418523, 1866008, 4701116, 1830790, 1806772, &
       9571771, 5492024, 5955560, 17010529, 8203752, &
       10733710, 6418358, 9796195, 6299511, 1806772, &
       1832600, 4281876, 1867677, 4840322, 1833370, &
       1806772, 9609295, 5401600, 5882038, 15144585, &
       8515005, 10816476, 6397844, 9688823, 6258209, &
       1806772, 1844442, 4034370, 1888230, 4864320, &
       1836047, 1806772, 9616565, 5485418, 5830999, &
       14994051, 8816547, 10896340, 6378138, 9647275, &
       6235848, 1806772, 1866589, 4079293, 1910551, &
       4799857, 1838636, 1806772, 9583654, 5543724, &
       5829011, 14974744, 9265947, 10998625, 6366379, &
       9710880, 9579953, 1812846, 1806772, 1908247, &
       3840067, 1926018, 4689702, 1842240, 1806772, &
       9989856, 5601757, 5861083, 15082561, 9670422, &
       11075986, 6354493, 9799777, 9632210, 1806772, &
       1947617, 3815898, 1931557, 4558895, 1845451, &
       1806772, 10027153, 5596559, 5827618, 14917194, &
       9855922, 11047414, 6287154, 9652295, 9466005, &
       1806772, 2016328, 3878797, 1956206, 4463391, &
       1848582, 1806772, 10089050, 5530455, 5798734, &
       14820778, 10060720, 11035699, 6239090, 9569357, &
       9367853, 1806772, 2115724, 3632985, 1966486, &
       4358355, 1852245, 1806772, 10081092, 5649815, &
       5822828, 14982460, 10477874, 11092294, 6224610, &
       9631446, 9319767, 1812093, 5358364, 1806772, &
       2254582, 3430303, 1982728, 4597674, 1856105, &
       1806772, 10074852, 5723026, 5903453, 15056598, &
       10920035, 11184804, 6229688, 9774387, 9452303, &
       1806772, 2382219, 3449281, 2033264, 4459072, &
       1860256, 1806772, 10017364, 5671563, 5932708, &
       14958382, 11147594, 11196630, 6196067, 9740769, &
       9428237, 1806772, 2538693, 3387763, 2051218, &
       4403718, 1865027, 1806772, 10168821, 5755692, &
       5958789, 14834299, 11358476, 11224738, 6170558, &
       9714719, 9395140, 1806772, 2744866, 3242550, &
       2182368, 4334888, 1869780, 1806800, 10072464, &
       5796127, 6014647, 14798581, 11629065, 11315625, &
       6168347, 9798325, 9473869, 1806772, 2916372, &
       3251030, 2334017, 4229697, 1872617, 1806800, &
       10065748, 5849350, 6070730, 14858342, 7769598, &
       11439381, 6131472, 9953053, 9631141, 1806772, &
       3035144, 3048640, 2472501, 4086529, 1871451, &
       1806800, 10077509, 5819033, 6108135, 14855787, &
       7940324, 11541199, 6141838, 10019444, 9711205, &
       1806772, 3125321, 2917621, 2584316, 3934037 /)
  
  print *, 'Testing reading GRIB2 file ', TEST_FILE
  print *, 'trying getgb2()...'

  ! Open the file.
  call baopenr(lugb, TEST_FILE, iret)
  if (iret .ne. 0) stop 2

  ! Learn about the file.
  jids = -9999
  jpdt = -9999
  jgdt = -9999
  call getgb2(lugb, 0, jskp, jdisc, jids, jpdtn, jpdt, jgdtn, jgdt,  &
          unpack, jskp, gfld, iret)
  if (iret .ne. 0) stop 3

  ! Close the file.
  call baclose(lugb, iret)  
  if (iret .ne. 0) stop 200

  ! Free memory.
  call gf_free(gfld)
  call gf_finalize(iret)
  if (iret .ne. 0) stop 5
  
  print *, 'OK!'
  print *, 'trying skgb8()...'
  
  ! Open the file.
  call baopenr(lugb, TEST_FILE, iret)
  if (iret .ne. 0) stop 2

  ! Loop through the file, checking location of each message.
  start8 = 0
  do i = 1, NUM_MSG
     call skgb8(lugb, start8, 10000_8, lskip8, lgrib8)
     if (lskip8 .ne. expected_lskip8(i)) stop 101
     if (lgrib8 .ne. expected_lgrib8(i)) stop 102
     start8 = start8 + lgrib8
  end do

  ! Close the file.
  call baclose(lugb, iret)  
  if (iret .ne. 0) stop 200

  print *, 'OK!'
  print *, 'SUCCESS!'
end program test_fv3
